

### Нагрузочное тестирование с помощью wrk2 (Профилирование PUT запросов)
Скрипт put.lua, для наполнения базы
```
counter = 0

request = function()
    path = "/v0/entity?id=key" .. counter
    wrk.method = "PUT"
    wrk.body = "value" .. counter
    counter = counter + 1
    return wrk.format(nil, path)
end
```
Команда для выполнения нагрузочного тестирования
```
wrk2 -c 1 -t 1 -d 2m -R 10000 -L -s wrk/put.lua http://localhost:8080
```
Результат
```
Running 2m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 0.940ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   463.37ms  740.71ms   2.59s    80.77%
    Req/Sec    10.52k     5.80k   25.44k    65.84%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.27ms
 75.000%  822.78ms
 90.000%    1.81s 
 99.000%    2.40s 
 99.900%    2.56s 
 99.990%    2.59s 
 99.999%    2.60s 
100.000%    2.60s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.040     0.000000            1         1.00
       0.323     0.100000       109667         1.11
       0.571     0.200000       218681         1.25
       0.811     0.300000       328045         1.43
       1.042     0.400000       437086         1.67
       1.267     0.500000       546305         2.00
       1.383     0.550000       601103         2.22
       1.548     0.600000       655686         2.50
     159.359     0.650000       710147         2.86
     489.471     0.700000       764786         3.33
     822.783     0.750000       819503         4.00
     988.671     0.775000       846740         4.44
    1151.999     0.800000       874012         5.00
    1320.959     0.825000       901329         5.71
    1486.847     0.850000       928643         6.67
    1650.687     0.875000       956143         8.00
    1731.583     0.887500       969701         8.89
    1810.431     0.900000       983355        10.00
    1894.399     0.912500       997038        11.43
    1975.295     0.925000      1010623        13.33
    2057.215     0.937500      1024313        16.00
    2099.199     0.943750      1031301        17.78
    2140.159     0.950000      1038180        20.00
    2179.071     0.956250      1044940        22.86
    2217.983     0.962500      1051800        26.67
    2258.943     0.968750      1058510        32.00
    2279.423     0.971875      1061920        35.56
    2301.951     0.975000      1065488        40.00
    2322.431     0.978125      1068731        45.71
    2342.911     0.981250      1072083        53.33
    2365.439     0.984375      1075702        64.00
    2375.679     0.985938      1077403        71.11
    2387.967     0.987500      1079068        80.00
    2398.207     0.989062      1081062        91.43
    2410.495     0.990625      1082450       106.67
    2422.783     0.992188      1083984       128.00
    2430.975     0.992969      1085056       142.22
    2437.119     0.993750      1085687       160.00
    2447.359     0.994531      1086656       182.86
    2457.599     0.995313      1087552       213.33
    2467.839     0.996094      1088260       256.00
    2473.983     0.996484      1088791       284.44
    2480.127     0.996875      1089177       320.00
    2492.415     0.997266      1089534       365.71
    2504.703     0.997656      1089978       426.67
    2523.135     0.998047      1090449       512.00
    2531.327     0.998242      1090616       568.89
    2539.519     0.998437      1090814       640.00
    2545.663     0.998633      1091027       731.43
    2555.903     0.998828      1091309       853.33
    2559.999     0.999023      1091482      1024.00
    2564.095     0.999121      1091569      1137.78
    2568.191     0.999219      1091664      1280.00
    2572.287     0.999316      1091782      1462.86
    2576.383     0.999414      1091910      1706.67
    2580.479     0.999512      1092021      2048.00
    2582.527     0.999561      1092068      2275.56
    2584.575     0.999609      1092124      2560.00
    2586.623     0.999658      1092176      2925.71
    2588.671     0.999707      1092237      3413.33
    2590.719     0.999756      1092338      4096.00
    2590.719     0.999780      1092338      4551.11
    2590.719     0.999805      1092338      5120.00
    2590.719     0.999829      1092338      5851.43
    2592.767     0.999854      1092390      6826.67
    2592.767     0.999878      1092390      8192.00
    2594.815     0.999890      1092449      9102.22
    2594.815     0.999902      1092449     10240.00
    2594.815     0.999915      1092449     11702.86
    2594.815     0.999927      1092449     13653.33
    2594.815     0.999939      1092449     16384.00
    2596.863     0.999945      1092511     18204.44
    2596.863     1.000000      1092511          inf
#[Mean    =      463.367, StdDeviation   =      740.712]
#[Max     =     2594.816, Total count    =      1092511]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1192550 requests in 2.00m, 76.20MB read
  Socket errors: connect 0, read 0, write 0, timeout 3
Requests/sec:   9936.56
Transfer/sec:    650.15KB
```
Для запуска профилирования использовалась команда (CPU)
```
./async-profiler/profiler.sh -d 30 -f cpuPut.html 14174 
```
[Результат профилирования CPU](cpuPut.png)

Для запуска профилирования использовалась команда (alloc)
```
./async-profiler/profiler.sh -e alloc -f memPut.html 14174
```
[Результат профилирования alloc](memPut.png)

Результаты тестирования показали, что 75% запросов обрабатываются с минимальной задержкой.
При этом около 10% запросов обладало задержкой более 1 секунды.

Результаты профилирования CPU показали, большая часть задержки наблюдается при методе flush (25.90%).
<ul>
  <li>62.15% - Обработка запросов</li>
  <li>7.17% - запись в сокет</li>
  <li>5-6% - чтение из сокета</li>
</ul>

Результаты профилирования alloc показали, что при копировании ByteBuffer расходуется большая часть памяти.
<ul>
  <li>7.54% - flush данных</li>
  <li>3.81% - MemTable</li>
  <li>16.87% - работа с DAO</li>
  <li>55.8% - обработка запросов</li>
  <li>17.76% - парсинг запроса</li>
</ul>

### Нагрузочное тестирование с помощью wrk2 (Профилирование GET запросов)
Скрипт get.lua
```
counter = 0

request = function()
    path = "/v0/entity?id=key" .. counter
    wrk.method = "GET"
    wrk.body = "value" .. counter
    counter = counter + 1
    return wrk.format(nil, path)
end
```
Команда для выполнения нагрузочного тестирования
```
wrk2 -c 1 -t 1 -d 2m -R 10000 -L -s wrk/get.lua http://localhost:8080
```
Результат
```
Running 2m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.099ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.12ms    2.12ms  54.50ms   96.26%
    Req/Sec    10.57k     1.46k   21.89k    84.30%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.86ms
 75.000%    1.23ms
 90.000%    1.52ms
 99.000%    7.68ms
 99.900%   39.23ms
 99.990%   52.22ms
 99.999%   54.33ms
100.000%   54.53ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.034     0.000000            1         1.00
       0.231     0.100000       110230         1.11
       0.395     0.200000       220553         1.25
       0.553     0.300000       330188         1.43
       0.708     0.400000       440313         1.67
       0.859     0.500000       550339         2.00
       0.933     0.550000       605522         2.22
       1.006     0.600000       660387         2.50
       1.078     0.650000       715260         2.86
       1.149     0.700000       770236         3.33
       1.225     0.750000       825328         4.00
       1.266     0.775000       853075         4.44
       1.307     0.800000       880195         5.00
       1.351     0.825000       907923         5.71
       1.396     0.850000       934977         6.67
       1.452     0.875000       962629         8.00
       1.485     0.887500       976314         8.89
       1.520     0.900000       990240        10.00
       1.571     0.912500      1003717        11.43
       1.692     0.925000      1017500        13.33
       1.939     0.937500      1031209        16.00
       2.125     0.943750      1038075        17.78
       2.383     0.950000      1044932        20.00
       2.753     0.956250      1051809        22.86
       3.235     0.962500      1058686        26.67
       3.867     0.968750      1065554        32.00
       4.243     0.971875      1068995        35.56
       4.639     0.975000      1072438        40.00
       5.135     0.978125      1075877        45.71
       5.679     0.981250      1079316        53.33
       6.263     0.984375      1082734        64.00
       6.607     0.985938      1084469        71.11
       6.975     0.987500      1086186        80.00
       7.395     0.989062      1087897        91.43
       7.867     0.990625      1089619       106.67
       8.431     0.992188      1091336       128.00
       8.759     0.992969      1092188       142.22
       9.111     0.993750      1093058       160.00
       9.487     0.994531      1093918       182.86
      10.055     0.995313      1094769       213.33
      10.983     0.996094      1095625       256.00
      11.703     0.996484      1096055       284.44
      12.599     0.996875      1096484       320.00
      13.703     0.997266      1096914       365.71
      15.399     0.997656      1097343       426.67
      22.591     0.998047      1097772       512.00
      26.415     0.998242      1097987       568.89
      28.559     0.998437      1098203       640.00
      33.535     0.998633      1098417       731.43
      36.447     0.998828      1098634       853.33
      39.807     0.999023      1098847      1024.00
      42.367     0.999121      1098954      1137.78
      44.479     0.999219      1099064      1280.00
      45.343     0.999316      1099169      1462.86
      45.855     0.999414      1099278      1706.67
      47.807     0.999512      1099383      2048.00
      48.287     0.999561      1099438      2275.56
      48.767     0.999609      1099491      2560.00
      49.375     0.999658      1099545      2925.71
      49.823     0.999707      1099600      3413.33
      50.463     0.999756      1099653      4096.00
      50.687     0.999780      1099681      4551.11
      50.911     0.999805      1099708      5120.00
      51.135     0.999829      1099737      5851.43
      51.391     0.999854      1099760      6826.67
      51.743     0.999878      1099787      8192.00
      51.935     0.999890      1099801      9102.22
      52.383     0.999902      1099813     10240.00
      52.895     0.999915      1099829     11702.86
      53.087     0.999927      1099840     13653.33
      53.343     0.999939      1099854     16384.00
      53.471     0.999945      1099861     18204.44
      53.599     0.999951      1099868     20480.00
      53.727     0.999957      1099874     23405.71
      53.855     0.999963      1099881     27306.67
      53.983     0.999969      1099889     32768.00
      54.015     0.999973      1099890     36408.89
      54.079     0.999976      1099896     40960.00
      54.111     0.999979      1099897     46811.43
      54.175     0.999982      1099901     54613.33
      54.239     0.999985      1099904     65536.00
      54.271     0.999986      1099906     72817.78
      54.303     0.999988      1099907     81920.00
      54.335     0.999989      1099909     93622.86
      54.367     0.999991      1099910    109226.67
      54.399     0.999992      1099912    131072.00
      54.431     0.999993      1099913    145635.56
      54.463     0.999994      1099916    163840.00
      54.463     0.999995      1099916    187245.71
      54.463     0.999995      1099916    218453.33
      54.463     0.999996      1099916    262144.00
      54.495     0.999997      1099919    291271.11
      54.495     0.999997      1099919    327680.00
      54.495     0.999997      1099919    374491.43
      54.495     0.999998      1099919    436906.67
      54.495     0.999998      1099919    524288.00
      54.495     0.999998      1099919    582542.22
      54.495     0.999998      1099919    655360.00
      54.495     0.999999      1099919    748982.86
      54.495     0.999999      1099919    873813.33
      54.495     0.999999      1099919   1048576.00
      54.527     0.999999      1099920   1165084.44
      54.527     1.000000      1099920          inf
#[Mean    =        1.119, StdDeviation   =        2.123]
#[Max     =       54.496, Total count    =      1099920]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1199957 requests in 2.00m, 78.96MB read
  Non-2xx or 3xx responses: 1199957
Requests/sec:   9999.66
Transfer/sec:    673.81KB

```
Для запуска профилирования использовалась команда (CPU)
```
./async-profiler/profiler.sh -d 30 -f cpuGet.html 14174
```
[Результат профилирования CPU](cpuGet.png)

Для запуска профилирования использовалась команда (alloc)
```
./async-profiler/profiler.sh -d 30 -e alloc -f memGet.html 14174
```
[Результат профилирования alloc](memGet.png)

Результаты тестирования показали, что запросы обрабатываются с минимальной задержкой.

Результаты профилирования CPU показали, что HttpSession.processRead использует 91.39%, на обработку запроса - 67.66%, из которых почти все время отправка запроса - 62.25%. Работа реализованного HttpRestService.get - 3.53%.

Результаты профилирования alloc показали что, HttpSession.processRead использует 92.61% - база. На обработку запроса - 63,03%. Работа реализованного HttpRestService.get - 51.85%. Можно заметить, что много затрат уходит на различные итераторы.  


